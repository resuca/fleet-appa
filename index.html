<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fleet Manager Pro - v47.0</title>
    
    <script>
        // â˜…é€£æºç”¨URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxeLEiKGP2Gn1142ic8Nug_UIOvbkJeNqonghmNZFuGmOHs8u18A3E3B0PJbqvEfhpi/exec"; 
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* --- Styles (v44ãƒ™ãƒ¼ã‚¹) --- */
        :root {
            --sidebar-bg: #111827; --sidebar-hover: rgba(255,255,255,0.1);
            --main-bg: #F3F4F6; --card-bg: #FFFFFF;
            --status-running: #10B981; --status-stop: #6B7280;
            --alert-critical: #EF4444; --alert-warning: #F59E0B;
            --primary-blue: #2563EB; --text-primary: #1F2937; --text-secondary: #6B7280; --border-color: #E5E7EB;
        }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: var(--main-bg); margin: 0; color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; }
        .hidden { display: none !important; }
        button { cursor: pointer; user-select: none; font-family: 'Noto Sans JP', sans-serif; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--primary-blue); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login */
        #screen-login { position: fixed; inset: 0; background: var(--main-bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .login-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        
        /* Admin Layout */
        .sidebar { width: 250px; background-color: var(--sidebar-bg); color: #9CA3AF; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-area { padding: 25px; font-weight: 700; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; }
        .logo-dot { width: 10px; height: 10px; background: var(--status-running); border-radius: 50%; margin-right: 10px; box-shadow: 0 0 10px var(--status-running); }
        .nav-item { padding: 16px 25px; cursor: pointer; display: flex; align-items: center; border-left: 3px solid transparent; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background-color: var(--sidebar-hover); color: white; border-left-color: var(--status-running); }
        .nav-icon { margin-right: 15px; width: 24px; text-align: center; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; width: 100%; }
        
        .header-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 25px; }
        
        /* Form & Inputs */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--text-secondary); margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        
        /* Status Panel */
        .status-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .status-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-top: 4px solid transparent; }
        .card-running { border-top-color: var(--status-running); }
        .card-stop { border-top-color: var(--status-stop); }
        .card-alert { border-top-color: var(--alert-critical); }
        .status-value { font-family: 'Roboto Mono', monospace; font-size: 2.5rem; font-weight: 700; }

        .alert-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .alert-card { background: white; border-radius: 8px; padding: 15px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { text-align: left; padding: 12px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); font-size: 0.8rem; background: #F9FAFB; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        .tag { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .tag-lease { background: #F3E8FF; color: #7E22CE; } .tag-asset { background: #E0E7FF; color: #3730A3; }
        .badge-run { color: var(--status-running); font-weight: bold; }
        
        /* Modal Style */
        #modal-maint { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-card { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 10px; }
        .maint-section-title { font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: var(--primary-blue); background: #EFF6FF; padding: 5px 10px; border-radius: 4px; }

        /* Driver Mobile */
        .mobile-wrapper { max-width: 480px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; background: #F8FAFC; border-left: 1px solid #ddd; border-right: 1px solid #ddd; width: 100%; }
        .m-header { padding: 15px; background: white; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .m-content { padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .m-card { background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .vehicle-btn { background: white; border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .vehicle-btn:active { background: #E2E8F0; }
        .vehicle-btn.running { background: #D1FAE5; border-color: var(--status-running); color: #065F46; pointer-events: none; opacity: 0.7; }
        
        /* Checks & Camera */
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F1F5F9; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--status-running); }
        input:checked + .slider:before { transform: translateX(22px); }

        .camera-box { position: relative; width: 100%; height: 240px; background: #000; border-radius: 8px; overflow: hidden; margin-top: 10px; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        img.snap { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; z-index: 10; }
        .guide-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 80px; border: 3px solid var(--status-running); box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); z-index: 15; pointer-events: none; }
        .btn-shutter { position: absolute; bottom: 20px; width: 70px; height: 70px; border-radius: 50%; background: transparent; border: 4px solid white; z-index: 20; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-shutter::after { content: ''; display: block; width: 56px; height: 56px; background: white; border-radius: 50%; transition: transform 0.1s; }
        .btn-shutter:active::after { transform: scale(0.9); background: #e5e5e5; }

        /* Buttons & Inputs */
        .btn-primary { background-color: var(--primary-blue); color: white; padding: 12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
        .btn-csv { background-color: #059669; color: white; padding: 10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; width:100%; }
        .btn-csv:hover { background-color: #047857; }
        .m-btn-lg { width: 100%; padding: 16px; border-radius: 8px; border: none; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; cursor: pointer; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bg-green { background: var(--status-running); } .bg-orange { background: var(--alert-warning); } .bg-red { background: var(--alert-critical); }
        .btn-mini { padding: 5px 10px; background:white; border:1px solid #ccc; border-radius:4px; font-size:0.8rem; cursor: pointer; }
        .btn-del { color: var(--alert-critical); border-color: var(--alert-critical); }
        .btn-edit { background: var(--primary-blue); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; margin-right: 5px; }
        
        .odo-input { font-size: 2rem; padding: 10px; width: 100%; text-align: center; font-weight: bold; border: 2px solid var(--primary-blue); border-radius: 8px; box-sizing: border-box; background: #EFF6FF; color: var(--primary-blue); font-family: 'Roboto Mono'; }
        .ac-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 1rem; margin-top: 5px; }
        
        .export-panel { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-items: end; }
        
        .td-data-item { margin-bottom: 4px; font-size: 0.85rem; color: #374151; }
        .td-label { font-weight: bold; color: #6B7280; font-size: 0.75rem; margin-right: 5px; }
        .td-empty { color: #D1D5DB; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="loader" class="hidden"><div class="spinner"></div><div id="loader-msg">ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...</div></div>

    <div id="screen-login">
        <div class="login-box">
            <h2 style="color:#111827; margin-bottom:5px;">Fleet Manager</h2>
            <p style="color:#6B7280; font-size:0.9rem; margin-bottom:30px;">v47.0 Date Fix</p>
            <div id="api-warning" style="color:#EF4444; font-size:0.8rem; display:none; margin-bottom:10px;">â€»ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆURLæœªè¨­å®šï¼‰</div>
            <div style="text-align:left;">
                <label style="font-size:0.8rem; font-weight:bold;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="text" id="login-email" class="login-input" placeholder="admin@example.com" value="admin@example.com">
                <label style="font-size:0.8rem; font-weight:bold;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="login-pass" class="login-input" value="1234">
            </div>
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="tryLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div style="margin-top:20px; font-size:0.75rem; color:#9CA3AF; text-align:left;">ç®¡ç†è€…: admin@example.com<br>ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼: manager@example.com<br>ç¾å ´: driver@example.com<br>(PW: 1234)</div>
        </div>
    </div>

    <div id="app-admin" class="hidden" style="display:flex; width:100%;">
        <div class="sidebar">
            <div class="logo-area"><div class="logo-dot"></div> Fleet Monitor</div>
            <div class="nav-item active" id="nav-dash" onclick="switchPage('dashboard')"><span class="nav-icon">ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
            <div class="nav-item" id="nav-vehicles" onclick="switchPage('vehicles')"><span class="nav-icon">ğŸšš</span> è»Šä¸¡å°å¸³</div>
            <div class="nav-item" id="nav-maint" onclick="switchPage('maint')"><span class="nav-icon">ğŸ”§</span> ç‚¹æ¤œãƒ»æ¶ˆè€—å“</div>
            <div class="nav-item" id="nav-users" onclick="switchPage('users')"><span class="nav-icon">ğŸ‘¤</span> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>
            <div class="nav-item" id="nav-export" onclick="switchPage('export')" style="margin-top:20px; border-top:1px solid #333; color:#10B981;"><span class="nav-icon">ğŸ“¥</span> æ—¥å ±ç®¡ç†ãƒ»å‡ºåŠ›</div>
            <div class="nav-item" onclick="location.reload()" style="margin-top:auto;"><span class="nav-icon">â†©ï¸</span> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
        </div>

        <div class="main-content">
            <div id="page-dashboard" class="page-section">
                <div class="header-title">Dashboard <button class="btn-mini" onclick="fetchData()">ğŸ”„ æœ€æ–°æƒ…å ±ã«æ›´æ–°</button></div>
                <div class="status-panel">
                    <div class="status-card card-running"><div><div class="status-label">ç¨¼åƒä¸­</div><div class="status-value" id="val-running">-</div></div><div style="font-size:2rem;">ğŸšš</div></div>
                    <div class="status-card card-alert"><div><div class="status-label">ã‚¢ãƒ©ãƒ¼ãƒˆ (æœŸé™)</div><div class="status-value" id="val-alert" style="color:var(--alert-critical);">-</div></div><div style="font-size:2rem;">âš ï¸</div></div>
                    <div class="status-card card-stop"><div><div class="status-label">å…¨è»Šä¸¡æ•°</div><div class="status-value" id="val-total">-</div></div><div style="font-size:2rem;">ğŸ“‹</div></div>
                </div>
                <h3 style="color:#111827;">âš ï¸ æœŸé™åˆ‡ã‚Œãƒ»ç›´å‰ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
                <div class="alert-grid" id="dashboard-alerts"></div>
            </div>

            <div id="page-vehicles" class="page-section hidden">
                <div class="header-title">Vehicle Registry</div>
                <div class="card" style="border-left: 5px solid var(--primary-blue);">
                    <h3 style="margin-top:0;">æ–°è¦è»Šä¸¡ç™»éŒ²</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>è»Šä¸¡ç•ªå·</label><input type="text" id="reg-v-no" placeholder="è¶³ç«‹100ã‚1234"></div>
                        <div class="form-group"><label>è»Šç¨®</label><input type="text" id="reg-v-name" placeholder="4tã‚¦ã‚¤ãƒ³ã‚°"></div>
                        <div class="form-group"><label>åŒºåˆ†</label><select id="reg-v-type"><option value="lease">ãƒªãƒ¼ã‚¹</option><option value="asset">è‡ªç¤¾è³‡ç”£</option></select></div>
                    </div>
                    <button class="btn-primary" onclick="addVehicle()">ï¼‹ å°å¸³ã«ç™»éŒ²</button>
                </div>
                <div class="card">
                    <div style="overflow-x:auto;">
                        <table id="table-vehicles">
                            <thead><tr><th>No / è»Šç¨®</th><th>åŒºåˆ†</th><th>ç¾åœ¨çŠ¶æ…‹</th><th>ç¾åœ¨Odo</th><th>æ“ä½œ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-maint" class="page-section hidden">
                <div class="header-title">Maintenance</div>
                <div class="card">
                    <div style="overflow-x:auto;">
                        <table id="table-maint">
                            <thead>
                                <tr><th>è»Šä¸¡</th><th>è»Šæ¤œæœŸé™</th><th>ç‚¹æ¤œè¨ˆç”» (3ãƒ¶æœˆ/12ãƒ¶æœˆ/ä»–)</th><th>æ¶ˆè€—å“ (ã‚¿ã‚¤ãƒ¤/ãƒãƒƒãƒ†ãƒªãƒ¼)</th><th>æ“ä½œ</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="page-users" class="page-section hidden">
                <div class="header-title">Users Registry</div>
                <div class="card" style="border-left: 5px solid var(--primary-blue);">
                    <h3 style="margin-top:0;">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² / ç·¨é›†</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>æ°å</label><input type="text" id="reg-u-name" placeholder="æ°å"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="reg-u-email" placeholder="user@example.com"></div>
                        <div class="form-group"><label>Pass</label><input type="text" id="reg-u-pass" value="1234"></div>
                        <div class="form-group"><label>æ¨©é™</label><select id="reg-u-role"><option value="driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option><option value="manager">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option><option value="admin">ç®¡ç†è€…</option></select></div>
                        <div class="form-group"><label>å…è¨±æœŸé™</label><input type="date" id="reg-u-license"></div>
                    </div>
                    <button class="btn-primary" id="btn-user-save" onclick="addUser()">ï¼‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </button>
                </div>
                <div class="card">
                    <table id="table-users">
                        <thead><tr><th>æ°å</th><th>Email</th><th>æ¨©é™</th><th>å…è¨±æœŸé™</th><th>æ“ä½œ</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="page-export" class="page-section hidden">
                <div class="header-title">Reports Export</div>
                <div class="card">
                    <h3 style="margin-top:0; color:#065F46;">ğŸ“¥ æ—¥å ±ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›è¨­å®š</h3>
                    <div class="export-grid">
                        <div><label>é–‹å§‹æ—¥</label><input type="date" id="ex-start" class="login-input" style="margin:0;"></div>
                        <div><label>çµ‚äº†æ—¥</label><input type="date" id="ex-end" class="login-input" style="margin:0;"></div>
                        <div><label>è»Šä¸¡</label><select id="ex-car" class="login-input" style="margin:0;"><option value="">å…¨è»Šä¸¡</option></select></div>
                        <div><label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</label><select id="ex-driver" class="login-input" style="margin:0;"><option value="">å…¨å“¡</option></select></div>
                    </div>
                    <div style="margin-top:20px;">
                        <button class="btn-csv" onclick="downloadCSV()">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (Excelå½¢å¼)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-maint" class="hidden">
        <div class="modal-card">
            <div class="modal-title">æ•´å‚™ãƒ»æ¶ˆè€—å“æƒ…å ±ã®ç·¨é›†</div>
            <h3 id="modal-maint-title" style="margin-top:0; color:#4B5563;">è»Šä¸¡ç•ªå·</h3>
            <div class="maint-section-title">ğŸ“… æ³•å®šãƒ»ç‚¹æ¤œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
            <div class="form-grid">
                <div class="form-group"><label>è»Šæ¤œæº€äº†æ—¥</label><input type="date" id="edt-shaken"></div>
                <div class="form-group"><label>3ãƒ¶æœˆç‚¹æ¤œæ—¥</label><input type="date" id="edt-tenken3"></div>
                <div class="form-group"><label>12ãƒ¶æœˆç‚¹æ¤œæ—¥</label><input type="date" id="edt-tenken12"></div>
                <div class="form-group"><label>ãƒªãƒ¼ã‚¹/è‡ªä¸»ç‚¹æ¤œ</label><input type="date" id="edt-tenkenLease"></div>
            </div>
            <div class="maint-section-title">ğŸ”§ æ¶ˆè€—å“äº¤æ›å±¥æ­´</div>
            <div class="form-grid">
                <div class="form-group"><label>å¤ã‚¿ã‚¤ãƒ¤äº¤æ›æ—¥</label><input type="date" id="edt-tireS"></div>
                <div class="form-group"><label>å†¬ã‚¿ã‚¤ãƒ¤äº¤æ›æ—¥</label><input type="date" id="edt-tireW"></div>
                <div class="form-group"><label>ãƒãƒƒãƒ†ãƒªãƒ¼äº¤æ›æ—¥</label><input type="date" id="edt-battery"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn-mini" onclick="document.getElementById('modal-maint').classList.add('hidden')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="saveMaintFromModal()">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="app-driver" class="mobile-wrapper hidden">
        <div class="m-header"><div>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ¥­å‹™</div><div style="display:flex; gap:10px;"><button class="btn-mini" onclick="location.reload()">çµ‚äº†</button></div></div>
        <div class="m-content">
            <div id="d-step-1"><div class="m-card"><h3 style="margin-top:0;">è»Šä¸¡ã‚’é¸æŠ</h3><div id="vehicle-grid-area"></div></div></div>
            <div id="d-step-2" class="hidden">
                <div onclick="backToStep1()" style="margin-bottom:15px; font-weight:bold; cursor:pointer; color:var(--primary-blue);">â—€ æˆ»ã‚‹</div>
                <div class="m-card">
                    <h3 style="margin-top:0;">ä¹—è»Šå‰ç‚¹æ¤œ</h3>
                    <div class="check-item"><span class="check-label">ã‚¨ãƒ³ã‚¸ãƒ³ç•°éŸ³</span><label class="switch"><input type="checkbox" id="chk-engine" checked><span class="slider"></span></label></div>
                    <div class="check-item"><span class="check-label">ãƒ–ãƒ¬ãƒ¼ã‚­ç‚¹æ¤œ</span><label class="switch"><input type="checkbox" id="chk-brake" checked><span class="slider"></span></label></div>
                    <div class="check-item"><span class="check-label">ã‚¦ã‚¤ãƒ³ã‚«ãƒ¼ç‚¹æ¤œ</span><label class="switch"><input type="checkbox" id="chk-blinker" checked><span class="slider"></span></label></div>
                    <div class="check-item"><span class="check-label">ãƒ©ã‚¤ãƒˆç‚¹æ¤œ</span><label class="switch"><input type="checkbox" id="chk-light" checked><span class="slider"></span></label></div>
                    <div class="check-item"><span class="check-label">ãƒ¯ã‚¤ãƒ‘ãƒ¼</span><label class="switch"><input type="checkbox" id="chk-wiper" checked><span class="slider"></span></label></div>
                    <div class="check-item"><span class="check-label">ã‚¿ã‚¤ãƒ¤</span><label class="switch"><input type="checkbox" id="chk-tire" checked><span class="slider"></span></label></div>
                    <div style="margin-top:15px; text-align:right;"><button class="btn-mini" style="color:var(--alert-critical); border-color:var(--alert-critical);" onclick="openCamera('defect')">ğŸ“· ç•°å¸¸ç®‡æ‰€æ’®å½±</button></div>
                    <div id="box-defect" class="camera-box hidden"><video id="vid-defect" autoplay playsinline muted></video><div class="guide-frame"></div><div class="btn-shutter" onclick="snap('defect')"></div><img id="img-defect" class="snap hidden"><div style="position:absolute; bottom:20px; right:20px; z-index:25;"><button onclick="resetCam('defect')" class="btn-mini">ã‚¯ãƒªã‚¢</button></div></div>
                </div>
                <div class="m-card">
                    <label style="font-weight:bold;">é–‹å§‹ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼</label>
                    <input type="number" id="d-start-odo" class="odo-input">
                    <div style="text-align:right; font-size:0.9rem; margin-top:5px; margin-bottom:15px;">å‰å›: <span id="d-last-odo-disp">-</span> km</div>
                    <label style="display:block; margin-bottom:5px;">è¡Œãå…ˆ</label><input type="text" id="d-dest" class="ac-input" list="list-dest" placeholder="ä¾‹: æ±äº¬å·¥å ´"><datalist id="list-dest"></datalist>
                    <label style="display:block; margin-top:10px; margin-bottom:5px;">ç›®çš„</label><input type="text" id="d-purp" class="ac-input" list="list-purp" placeholder="ä¾‹: é…é€"><datalist id="list-purp"></datalist>
                    <label style="display:block; margin-top:10px; margin-bottom:5px;">åŒä¹—è€…</label><input type="text" id="d-pass" class="ac-input" list="list-pass" placeholder="ä¾‹: ä½è—¤ äºŒéƒ"><datalist id="list-pass"></datalist>
                </div>
                <button class="m-btn-lg bg-green" onclick="startWork()">ç‚¹æ¤œå®Œäº†ãƒ»å‡ºåº«</button>
            </div>
            <div id="d-step-driving" class="hidden"><div class="m-card" style="text-align:center; padding:40px 20px;"><h2 style="color:var(--status-running); margin-top:0;">ã”å®‰å…¨ã«ï¼</h2><div style="font-size:4rem;">ğŸššğŸ’¨</div><p id="d-running-info" style="font-weight:bold; font-size:1.2rem;"></p></div><button class="m-btn-lg bg-orange" onclick="goToReturn()">å¸°åº«ãƒ»æ—¥å ±ä½œæˆ</button></div>
            <div id="d-step-return" class="hidden">
                <div class="m-card">
                    <h3 style="margin-top:0;">æ—¥å ±å…¥åŠ›</h3>
                    <p style="font-size:0.9rem;">çµ‚äº†ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼æ’®å½±</p>
                    <div class="camera-box"><video id="vid-odo" autoplay playsinline muted></video><div class="guide-frame"></div><div class="btn-shutter" onclick="snap('odo')"></div><img id="img-odo" class="snap hidden"><div style="position:absolute; bottom:20px; right:20px; z-index:25;"><button onclick="resetCam('odo')" class="btn-mini">æ’®ã‚Šç›´ã—</button></div></div><canvas id="canvas-work" class="hidden"></canvas>
                    <label style="margin-top:15px; display:block;">çµ‚äº†è·é›¢å…¥åŠ›</label><input type="number" id="d-end-odo" class="odo-input" oninput="calcDist()"><div style="text-align:center; margin-top:5px; font-weight:bold;">æœ¬æ—¥èµ°è¡Œ: <span id="d-dist-val">0</span> km</div>
                    <label style="margin-top:15px; display:block;">é‹è»¢æ™‚é–“ (æ™‚é–“.å°æ•°)</label>
                    <input type="number" step="0.1" id="d-drive-time" class="ac-input" placeholder="ä¾‹: 1.5 (1æ™‚é–“30åˆ†)">
                </div>
                <button class="m-btn-lg bg-red" onclick="endWork()">æ—¥å ±é€ä¿¡ãƒ»æ¥­å‹™çµ‚äº†</button>
            </div>
            <div id="d-step-end" class="hidden"><div style="text-align:center; margin-top:80px;"><h1>ãŠç–²ã‚Œæ§˜ã§ã—ãŸ</h1><div style="font-size:4rem;">ğŸ </div><p>æ—¥å ±é€ä¿¡å®Œäº†</p></div></div>
        </div>
    </div>

    <script>
        // Init Data
        const DEMO_DATA = { 
            users: [
                { email: 'admin@example.com', pass: '1234', name: 'ç®¡ç†è€… å¤ªéƒ', role: 'admin', license: '2030-01-01' },
                { email: 'manager@example.com', pass: '1234', name: 'é‹è¡Œ ãƒãƒå­', role: 'manager', license: '2029-01-01' },
                { email: 'driver@example.com', pass: '1234', name: 'éˆ´æœ¨ ä¸€éƒ', role: 'driver', license: '2026-05-01' }
            ], 
            vehicles: [
                { id: 'v1', no: 'è¶³ç«‹100ã‚1111', name: '4tã‚¦ã‚¤ãƒ³ã‚°', assetType: 'lease', status: 'standby', lastOdo: 125000, shaken: '2026-02-01' },
                { id: 'v2', no: 'å“å·100ã„2222', name: '2tå¹³ãƒœãƒ‡ã‚£', assetType: 'asset', status: 'standby', lastOdo: 45000, shaken: '2025-12-31' },
                { id: 'v3', no: 'ç·´é¦¬400ã†3333', name: 'ãƒã‚¤ã‚¨ãƒ¼ã‚¹', assetType: 'lease', status: 'standby', lastOdo: 23000, shaken: '2026-05-20' },
                { id: 'v4', no: 'å¤šæ‘©100ãˆ4444', name: '10tå¤§å‹', assetType: 'lease', status: 'standby', lastOdo: 340000, shaken: '2025-11-15' },
                { id: 'v5', no: 'æ¨ªæµœ100ãŠ5555', name: '2tä¿å†·è»Š', assetType: 'asset', status: 'standby', lastOdo: 89000, shaken: '2026-03-10' },
                { id: 'v6', no: 'å·å´400ã‹6666', name: 'ãƒ—ãƒ­ãƒœãƒƒã‚¯ã‚¹', assetType: 'lease', status: 'standby', lastOdo: 12000, shaken: '2026-08-01' },
                { id: 'v7', no: 'ç›¸æ¨¡100ã7777', name: '4tãƒ¦ãƒ‹ãƒƒã‚¯', assetType: 'asset', status: 'standby', lastOdo: 67000, shaken: '2025-10-20' },
                { id: 'v8', no: 'åƒè‘‰100ã8888', name: '4tã‚¦ã‚¤ãƒ³ã‚°', assetType: 'lease', status: 'standby', lastOdo: 156000, shaken: '2026-01-10' },
                { id: 'v9', no: 'ç¿’å¿—é‡100ã‘9999', name: '2tå¹³ãƒœãƒ‡ã‚£', assetType: 'asset', status: 'standby', lastOdo: 54000, shaken: '2026-04-05' },
                { id: 'v10', no: 'å¤§å®®100ã“0001', name: 'å¤§å‹ãƒ€ãƒ³ãƒ—', assetType: 'lease', status: 'standby', lastOdo: 210000, shaken: '2025-12-01' },
                { id: 'v11', no: 'æ‰€æ²¢400ã•0002', name: 'NV350ã‚­ãƒ£ãƒ©ãƒãƒ³', assetType: 'lease', status: 'standby', lastOdo: 34000, shaken: '2026-07-20' },
                { id: 'v12', no: 'æ˜¥æ—¥éƒ¨100ã—0003', name: '4tå†·å‡è»Š', assetType: 'asset', status: 'standby', lastOdo: 98000, shaken: '2026-02-15' }
            ],
            reports: []
        };
        
        let localData = { users: [], vehicles: [], reports: [] };
        let currentUser = null; let currentVehId = null; 
        let workStartTime = null; let currentWorkData = {};
        let inputHistory = JSON.parse(localStorage.getItem('fleet_history')) || { dests:[], purps:[], passes:[] };
        let editTargetIndex = -1;
        let editingUserIdx = -1;

        // â˜… New: Safe Date Formatter (Prevents broken dates)
        function formatDate(raw) {
            if(!raw) return '';
            const d = new Date(raw);
            if(isNaN(d.getTime())) return '';
            const y = d.getFullYear();
            const m = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${y}-${m}-${day}`;
        }

        // --- Fetch & Save ---
        async function fetchData() {
            showLoader(true);
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                if (!data.users || data.users.length === 0) {
                    console.log("No users found. Initializing...");
                    localData = DEMO_DATA;
                    await saveAction({ action: 'init', ...DEMO_DATA });
                } else {
                    localData = data;
                }
                
                document.getElementById('api-warning').style.display = 'none';
                refreshAllViews();
            } catch(e) {
                console.error(e);
                alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼");
            } finally { showLoader(false); }
        }

        async function saveAction(payload) {
            showLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                await fetchData();
                if(payload.action !== 'report' && payload.action !== 'init') alert("ä¿å­˜ã—ã¾ã—ãŸ");
            } catch(e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); } finally { showLoader(false); }
        }

        function showLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }
        function refreshAllViews() {
            if(currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager')) { 
                updateDashboard(); renderVehicles(); renderMaintenance(); renderUsers(); updateExportOptions();
            }
            if(currentUser && currentUser.role === 'driver') initDriver();
        }

        async function tryLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            await fetchData();
            const user = localData.users.find(u => u.email === email && String(u.pass) === pass);
            if(user) {
                currentUser = user; document.getElementById('screen-login').classList.add('hidden');
                if(user.role === 'admin' || user.role === 'manager') { 
                    document.getElementById('app-admin').classList.remove('hidden'); switchPage('dashboard'); 
                } else { 
                    document.getElementById('app-driver').classList.remove('hidden'); initDriver(); 
                }
            } else alert('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        function switchPage(page) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + page).classList.remove('hidden');
            if(page==='dashboard') document.getElementById('nav-dash').classList.add('active');
            if(page==='vehicles') document.getElementById('nav-vehicles').classList.add('active');
            if(page==='maint') document.getElementById('nav-maint').classList.add('active');
            if(page==='users') document.getElementById('nav-users').classList.add('active');
            if(page==='export') document.getElementById('nav-export').classList.add('active');
            refreshAllViews();
        }

        function updateExportOptions() {
            const carSel = document.getElementById('ex-car');
            const drvSel = document.getElementById('ex-driver');
            carSel.innerHTML = '<option value="">å…¨è»Šä¸¡</option>';
            drvSel.innerHTML = '<option value="">å…¨å“¡</option>';
            localData.vehicles.forEach(v => { carSel.innerHTML += `<option value="${v.no}">${v.no} (${v.name})</option>`; });
            localData.users.forEach(u => { drvSel.innerHTML += `<option value="${u.name}">${u.name}</option>`; });
        }

        function updateDashboard() {
            const today = new Date(); const alertList = [];
            document.getElementById('val-running').innerText = localData.vehicles.filter(v => v.status === 'running').length;
            document.getElementById('val-total').innerText = localData.vehicles.length;
            const checkDate = (dateStr, title, msg) => {
                if(!dateStr) return; const limit = new Date(dateStr); const diff = Math.ceil((limit - today)/86400000);
                if(diff < 0) alertList.push({type:'critical', title, msg: `${msg} æœŸé™åˆ‡ã‚Œ`});
                else if(diff <= 30) alertList.push({type:'warning', title, msg: `${msg} æ®‹ã‚Š${diff}æ—¥`});
            };
            localData.vehicles.forEach(v => { checkDate(v.shaken,'è»Šæ¤œ',v.no); checkDate(v.tenken3,'3ãƒ¶æœˆç‚¹æ¤œ',v.no); });
            localData.users.forEach(u => checkDate(u.license,'å…è¨±',u.name));
            document.getElementById('val-alert').innerText = alertList.length;
            const con = document.getElementById('dashboard-alerts'); con.innerHTML = '';
            alertList.forEach(a => { const c = a.type==='critical'?'var(--alert-critical)':'var(--alert-warning)'; con.innerHTML += `<div class="alert-card" style="border-left-color:${c}"><strong style="color:${c}">${a.title}</strong><br>${a.msg}</div>`; });
        }

        function downloadCSV() {
            if(!localData.reports || localData.reports.length === 0) return alert("æ—¥å ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            const fStart = document.getElementById('ex-start').value;
            const fEnd = document.getElementById('ex-end').value;
            const fCar = document.getElementById('ex-car').value;
            const fDriver = document.getElementById('ex-driver').value;
            const filtered = localData.reports.filter(r => {
                const d = formatDate(r.date); // Use safe date
                if(fStart && d < fStart) return false;
                if(fEnd && d > fEnd) return false;
                if(fCar && r.carNo !== fCar) return false;
                if(fDriver && r.driver !== fDriver) return false;
                return true;
            });
            if(filtered.length === 0) return alert("æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            const csvHeader = [ 'ä½¿ç”¨æ—¥(æœˆ/æ—¥)', 'è»Šç•ª', 'è»Šç¨®', 'ç¤¾ç”¨è»Šå‚™ä»˜å“æºè¡Œå“æœ‰ç„¡', 'å‡ºç™ºæ™‚é–“', 'å¸°ç¤¾æ™‚é–“', 'é‹è»¢æ™‚é–“', 'ä½¿ç”¨è€…ï¼ˆåŒä¹—è€…ï¼‰', 'è¡Œãå…ˆ', 'ç›®çš„', 'ï½µï¾„ï¾ï¾’ï½°ï¾€ï½°', 'èµ°è¡Œè·é›¢', 'ï½´ï¾ï½¼ï¾ï¾ç•°éŸ³', 'ï¾Œï¾ï¾šï½°ï½·ç‚¹æ¤œ', 'ï½³ï½²ï¾ï½¶ï½°ç‚¹æ¤œ', 'ï¾—ï½²ï¾„ ç‚¹ç¯', 'ï¾œï½²ï¾Šï¾Ÿï½°', 'ï¾€ï½²ï¾”', 'ãã®ä»–' ];
            const csvRows = [csvHeader.join(',')];
            filtered.forEach(r => {
                const row = [ formatDate(r.date), r.carNo, r.carName, 'æœ‰', r.startTime, r.endTime, r.driveTime ? r.driveTime + 'H' : '', r.passenger ? `${r.driver} (${r.passenger})` : r.driver, r.destination, r.purpose, r.endOdo, r.distance, r.checkEngine ? 'ãƒ¬' : 'Ã—', r.checkBrake ? 'ãƒ¬' : 'Ã—', r.checkBlinker ? 'ãƒ¬' : 'Ã—', r.checkLight ? 'ãƒ¬' : 'Ã—', r.checkWiper ? 'ãƒ¬' : 'Ã—', r.checkTire ? 'ãƒ¬' : 'Ã—', '' ];
                csvRows.push(row.map(v => `"${v}"`).join(','));
            });
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvRows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `é‹è»¢æ—¥å ±_${new Date().toISOString().slice(0,10)}.csv`; a.click();
        }

        // CRUD
        function renderVehicles() {
            const tb = document.querySelector('#table-vehicles tbody'); tb.innerHTML = '';
            localData.vehicles.forEach((v, i) => {
                const st = v.status==='running' ? '<b class="badge-run">ç¨¼åƒä¸­</b>' : 'å¾…æ©Ÿä¸­';
                tb.innerHTML += `<tr><td><b>${v.no}</b><br>${v.name}</td><td>${v.assetType}</td><td>${st}</td><td>${v.lastOdo} km</td><td><button class="btn-mini btn-del" onclick="delVehicle(${i})">å‰Šé™¤</button></td></tr>`;
            });
        }
        function addVehicle() {
            const no = document.getElementById('reg-v-no').value; const name = document.getElementById('reg-v-name').value;
            if(!no || !name) return alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            const newV = { id: 'v'+Date.now(), no, name, assetType: document.getElementById('reg-v-type').value, lastOdo: 0, shaken: '', tenken3: '', tenken12: '', tenkenLease: '', tireS: '', tireW: '', battery: '', status: 'standby' };
            localData.vehicles.push(newV);
            saveAction({ action: 'update', vehicles: localData.vehicles, users: localData.users });
        }
        function delVehicle(i) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ localData.vehicles.splice(i,1); saveAction({ action: 'update', vehicles: localData.vehicles, users: localData.users }); } }

        function renderMaintenance() {
            const tb = document.querySelector('#table-maint tbody'); tb.innerHTML = '';
            localData.vehicles.forEach((v, i) => {
                let planHtml = '';
                if(v.tenken3) planHtml += `<div class="td-data-item"><span class="td-label">3ãƒ¶æœˆ</span>${formatDate(v.tenken3)}</div>`;
                if(v.tenken12) planHtml += `<div class="td-data-item"><span class="td-label">12ãƒ¶æœˆ</span>${formatDate(v.tenken12)}</div>`;
                if(v.tenkenLease) planHtml += `<div class="td-data-item"><span class="td-label">ãƒªãƒ¼ã‚¹</span>${formatDate(v.tenkenLease)}</div>`;
                if(!planHtml) planHtml = '<span class="td-empty">-</span>';
                let partHtml = '';
                if(v.tireS) partHtml += `<div class="td-data-item"><span class="td-label">å¤ã‚¿ã‚¤ãƒ¤</span>${formatDate(v.tireS)}</div>`;
                if(v.tireW) partHtml += `<div class="td-data-item"><span class="td-label">å†¬ã‚¿ã‚¤ãƒ¤</span>${formatDate(v.tireW)}</div>`;
                if(v.battery) partHtml += `<div class="td-data-item"><span class="td-label">ãƒãƒƒãƒ†ãƒªãƒ¼</span>${formatDate(v.battery)}</div>`;
                if(!partHtml) partHtml = '<span class="td-empty">-</span>';
                tb.innerHTML += `<tr><td><b>${v.no}</b><br>${v.name}</td><td>${formatDate(v.shaken) || '<span class="td-empty">-</span>'}</td><td>${planHtml}</td><td>${partHtml}</td><td><button class="btn-edit" onclick="openMaintModal(${i})">âœï¸ ç·¨é›†</button></td></tr>`;
            });
        }
        
        function openMaintModal(i) {
            editTargetIndex = i; const v = localData.vehicles[i];
            document.getElementById('modal-maint-title').innerText = `${v.no} (${v.name})`;
            document.getElementById('edt-shaken').value = formatDate(v.shaken);
            document.getElementById('edt-tenken3').value = formatDate(v.tenken3);
            document.getElementById('edt-tenken12').value = formatDate(v.tenken12);
            document.getElementById('edt-tenkenLease').value = formatDate(v.tenkenLease);
            document.getElementById('edt-tireS').value = formatDate(v.tireS);
            document.getElementById('edt-tireW').value = formatDate(v.tireW);
            document.getElementById('edt-battery').value = formatDate(v.battery);
            document.getElementById('modal-maint').classList.remove('hidden');
        }
        function saveMaintFromModal() {
            if(editTargetIndex === -1) return;
            const v = localData.vehicles[editTargetIndex];
            v.shaken = document.getElementById('edt-shaken').value;
            v.tenken3 = document.getElementById('edt-tenken3').value;
            v.tenken12 = document.getElementById('edt-tenken12').value;
            v.tenkenLease = document.getElementById('edt-tenkenLease').value;
            v.tireS = document.getElementById('edt-tireS').value;
            v.tireW = document.getElementById('edt-tireW').value;
            v.battery = document.getElementById('edt-battery').value;
            document.getElementById('modal-maint').classList.add('hidden');
            saveAction({ action: 'update', vehicles: localData.vehicles, users: localData.users });
        }

        // Users
        function renderUsers() {
            const tb = document.querySelector('#table-users tbody'); tb.innerHTML = '';
            localData.users.forEach((u, i) => { 
                tb.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${formatDate(u.license)}</td><td><button class="btn-edit" onclick="editUser(${i})">âœï¸ ç·¨é›†</button><button class="btn-mini btn-del" onclick="delUser(${i})">å‰Šé™¤</button></td></tr>`; 
            });
        }
        function editUser(i) {
            editingUserIdx = i; const u = localData.users[i];
            document.getElementById('reg-u-name').value = u.name;
            document.getElementById('reg-u-email').value = u.email;
            document.getElementById('reg-u-pass').value = u.pass;
            document.getElementById('reg-u-role').value = u.role;
            document.getElementById('reg-u-license').value = formatDate(u.license);
            const btn = document.getElementById('btn-user-save');
            btn.innerText = "ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°"; btn.style.backgroundColor = "#F59E0B"; 
        }
        function addUser() {
            const name = document.getElementById('reg-u-name').value; const email = document.getElementById('reg-u-email').value; const pass = document.getElementById('reg-u-pass').value;
            if(!name || !email) return alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            const newUser = { name, email, pass, role: document.getElementById('reg-u-role').value, license: document.getElementById('reg-u-license').value };
            if(editingUserIdx >= 0) {
                localData.users[editingUserIdx] = newUser; editingUserIdx = -1;
                const btn = document.getElementById('btn-user-save'); btn.innerText = "ï¼‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ "; btn.style.backgroundColor = "var(--primary-blue)";
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
                localData.users.push(newUser); alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
            }
            document.getElementById('reg-u-name').value = ''; document.getElementById('reg-u-email').value = '';
            document.getElementById('reg-u-pass').value = '1234'; document.getElementById('reg-u-license').value = '';
            saveAction({ action: 'update', vehicles: localData.vehicles, users: localData.users });
        }
        function delUser(i) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ localData.users.splice(i,1); saveAction({ action: 'update', vehicles: localData.vehicles, users: localData.users }); } }

        function initDriver() {
            const grid = document.getElementById('vehicle-grid-area'); grid.innerHTML = '';
            localData.vehicles.forEach(v => {
                const btn = document.createElement('div'); btn.className = `vehicle-btn ${v.status==='running'?'running':''}`;
                btn.innerHTML = `<div style="font-size:2rem;">ğŸšš</div><div>${v.no}</div><div style="font-size:0.8rem;">${v.name}</div>`;
                btn.onclick = () => { if(v.status!=='running') selectVehicle(v.id); };
                grid.appendChild(btn);
            });
            updateDatalists();
        }
        function updateDatalists() {
            document.getElementById('list-dest').innerHTML = inputHistory.dests.map(v=>`<option value="${v}">`).join('');
            document.getElementById('list-purp').innerHTML = inputHistory.purps.map(v=>`<option value="${v}">`).join('');
            document.getElementById('list-pass').innerHTML = inputHistory.passes.map(v=>`<option value="${v}">`).join('');
        }
        function selectVehicle(vid) { 
            currentVehId = vid; const v = localData.vehicles.find(val => val.id === vid); 
            document.getElementById('d-last-odo-disp').innerText = v.lastOdo; 
            document.getElementById('d-start-odo').value = v.lastOdo; 
            document.getElementById('d-step-1').classList.add('hidden'); document.getElementById('d-step-2').classList.remove('hidden'); 
        }
        function backToStep1() { document.getElementById('d-step-2').classList.add('hidden'); document.getElementById('d-step-1').classList.remove('hidden'); }
        
        function startWork() {
            const inputOdo = parseInt(document.getElementById('d-start-odo').value); 
            const dest = document.getElementById('d-dest').value; const purp = document.getElementById('d-purp').value; const pass = document.getElementById('d-pass').value;
            const idx = localData.vehicles.findIndex(v => v.id === currentVehId);
            if(inputOdo < localData.vehicles[idx].lastOdo) return alert('ã‚¨ãƒ©ãƒ¼: å‰å›å€¤ã‚ˆã‚Šå°ã•ã„æ•°å€¤ã¯å…¥åŠ›ã§ãã¾ã›ã‚“');
            if(!dest || !purp) return alert('è¡Œãå…ˆã¨ç›®çš„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if(!inputHistory.dests.includes(dest)) inputHistory.dests.push(dest);
            if(!inputHistory.purps.includes(purp)) inputHistory.purps.push(purp);
            if(pass && !inputHistory.passes.includes(pass)) inputHistory.passes.push(pass);
            localStorage.setItem('fleet_history', JSON.stringify(inputHistory));
            workStartTime = new Date();
            currentWorkData = {
                startOdo: inputOdo, destination: dest, purpose: purp, passenger: pass,
                checkEngine: document.getElementById('chk-engine').checked, checkBrake: document.getElementById('chk-brake').checked, checkBlinker: document.getElementById('chk-blinker').checked, checkLight: document.getElementById('chk-light').checked, checkWiper: document.getElementById('chk-wiper').checked, checkTire: document.getElementById('chk-tire').checked
            };
            localData.vehicles[idx].status = 'running'; 
            saveAction({ action: 'update', vehicles: localData.vehicles, users: localData.users }); 
            document.getElementById('d-running-info').innerText = `${localData.vehicles[idx].no} èµ°è¡Œä¸­`;
            document.getElementById('d-step-2').classList.add('hidden'); document.getElementById('d-step-driving').classList.remove('hidden');
        }
        
        function goToReturn() { 
            document.getElementById('d-step-driving').classList.add('hidden'); 
            document.getElementById('d-step-return').classList.remove('hidden'); 
            openCamera('odo'); 
            const now = new Date();
            if(!workStartTime) workStartTime = new Date(now.getTime() - (60*60*1000));
            const diffMs = now - workStartTime;
            const hours = diffMs / (1000 * 60 * 60);
            const rounded = Math.round(hours * 10) / 10; 
            document.getElementById('d-drive-time').value = rounded;
        }
        function calcDist() { const s = currentWorkData.startOdo; const e = parseInt(document.getElementById('d-end-odo').value)||0; document.getElementById('d-dist-val').innerText = Math.max(0, e-s); }
        async function endWork() {
            const endOdo = document.getElementById('d-end-odo').value; const driveTime = document.getElementById('d-drive-time').value;
            if(!endOdo) return alert('å…¥åŠ›ã—ã¦ãã ã•ã„');
            const idx = localData.vehicles.findIndex(v => v.id === currentVehId);
            const v = localData.vehicles[idx];
            const distance = parseInt(endOdo) - currentWorkData.startOdo;
            const endTime = new Date();
            const reportData = {
                date: new Date().toISOString().slice(0,10), carNo: v.no, carName: v.name, driver: currentUser.name,
                startTime: workStartTime.toTimeString().slice(0,5), endTime: endTime.toTimeString().slice(0,5), driveTime: driveTime,
                destination: currentWorkData.destination, purpose: currentWorkData.purpose, passenger: currentWorkData.passenger,
                startOdo: currentWorkData.startOdo, endOdo: parseInt(endOdo), distance: distance,
                checkEngine: currentWorkData.checkEngine, checkBrake: currentWorkData.checkBrake, checkBlinker: currentWorkData.checkBlinker, checkLight: currentWorkData.checkLight, checkWiper: currentWorkData.checkWiper, checkTire: currentWorkData.checkTire
            };
            const vehicleUpdate = { id: v.id, status: 'standby', lastOdo: parseInt(endOdo) };
            await saveAction({ action: 'report', reportData: reportData, vehicleData: vehicleUpdate });
            document.getElementById('d-step-return').classList.add('hidden'); document.getElementById('d-step-end').classList.remove('hidden'); setTimeout(() => { location.reload(); }, 3000);
        }

        async function openCamera(type) {
            const vid = document.getElementById(type === 'defect' ? 'vid-defect' : 'vid-odo');
            const box = document.getElementById(type === 'defect' ? 'box-defect' : '');
            if(box) box.classList.remove('hidden');
            try { const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); vid.srcObject = s; vid.play(); } 
            catch(e) { alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + e.message); }
        }
        function snap(type) {
            const vid = document.getElementById(type === 'defect' ? 'vid-defect' : 'vid-odo');
            const img = document.getElementById(type === 'defect' ? 'img-defect' : 'img-odo');
            const cvs = document.getElementById('canvas-work'); cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
            cvs.getContext('2d').drawImage(vid, 0, 0); img.src = cvs.toDataURL('image/png'); img.classList.remove('hidden');
            if(vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());
        }
        function resetCam(type) { document.getElementById(type === 'defect' ? 'img-defect' : 'img-odo').classList.add('hidden'); openCamera(type); }
    </script>
</body>
</html>
